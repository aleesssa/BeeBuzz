{% extends 'base.html' %}

{% block style %}
<link rel="stylesheet" href="/css/chatmessage.css">
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
{% endblock %}

{% block content %}
<h1>Chatbox</h1>

<div class="chatbox">
    <div id="messages" style="list-style: none;">
        {% for message in messages %}
            <!-- Get sender's name and message -->
           
            <div class="message  {% if message.sender_id == user_id %}me{% else %}them{% endif %}">
                {% if message.media_url %} 
                    {% if message.media_url.split('.')[1] in 'mp4' %} <video src="{{message.media_url}}" width="350px" controls> {% endif %}
                    {% if message.media_url.split('.')[1] in 'jpg jpeg gif png' %} <img src="{{ message.media_url }}" id="media" width="200px"> {% endif %}
                {% endif %}
                <div class="text">{{ users.filter_by(id=message.sender_id).first().username }} : {{ message.message }}</div>
                <!-- <div id="seen" class="{% if not(message.is_seen) %}hide{% endif %}">seen</div> -->
            </div> 

        {% endfor %}
    </div>
    <div id="typing" class="chat-bubble hide">
        <div class="typing">
          <div class="dot"></div>
          <div class="dot"></div>
          <div class="dot"></div>
        </div>
    </div>
    <!-- <div id="typing" class="hide">user is typing..</div> -->
    <form id="chat_form" enctype="multipart/form-data">
        <input type="text" name="message" id="chat_input" placeholder="Send a text">
        <input type="file" name="media" id="media">
        <button id="submit"><img src="/img/send.png" alt="send" width="20em"></button>
    </form>  
</div>



<script>
    const socket = io()
    const user_id = {{ session['user_id'] }}
    const requestID = {{ request_id }}
    const form = document.getElementById('chat_form')
    const input = document.getElementById('chat_input') // Needed to track Enter key presses
    const submitButton = document.getElementById('submit')
    const typing = document.getElementById('typing')
    const seen = document.getElementById('seen')
    const seenDiv = document.createElement('div');

    let read = false;

    // Join room for requestID
    socket.emit("join_room", {
        request_id: requestID
    });

    // Read receipt
    window.addEventListener('focus', ()=>{
        console.log('focused')
        console.log(read)
        if (!read){
            socket.emit('seen_message', {
                'user_id' : user_id,
                'request_id' : requestID
            })
            read = true
        }
    })


    // Listen for user_seen_message event from server
    socket.on('user_seen_message', (data)=>{
        console.log('seen')
        if (data.user_id !== user_id){
            seenDiv.classList.remove('hide')
        }
        read = false
    })

    // Listen to receive_message event by server
    socket.on("receive_message", (data) => {
        console.log('hello')
        const div = document.createElement("div");
        div.className = "message";
        seenDiv.className = 'hide'
        seenDiv.id = 'seen'
        
        // check who's the sender
        if (data.sender_id != user_id){
            div.classList.add('them');
        }else{
            div.classList.add('me');
        }


      div.innerText = data.sender_name + " : " + data.message;
      seenDiv.innerText = 'seen'

      div.appendChild(seenDiv)
      document.getElementById("messages").appendChild(div);
    });

    // Shows typing indicator when the other user is typing
    socket.on('is_typing_backend', (data)=>{
        if (data.user_id != user_id){
            typing.classList.remove('hide')
        }    
        // Clear any previous timeout to restart the countdown
        clearTimeout(window.typingIndicatorTimeout);

        // Start a new timeout to hide after 1.5s
        window.typingIndicatorTimeout = setTimeout(() => {
            typing.classList.add('hide')
        }, 1500);
    })


    let typing_timeout;
    // Click submit button when user presses enter
    input.addEventListener("keypress", (event) => {
        if (event.key === "Enter") {
            // Cancel the default action, if needed
            event.preventDefault();
            // Trigger sendButton with a click
            submitButton.click();
            return;
        }
        if (typing_timeout){
            return;
        
        }
        socket.emit('is_typing_frontend', {'user_id' : user_id, 'request_id':requestID})

        typing_timeout = setTimeout(()=>{
            typing_timeout = null
        }, 1000)

    }); 


    // send post request through fetch when form is submitted 
    submitButton.addEventListener('click', (e) => {
        console.log('hello')
        e.preventDefault();
        const formData = new FormData(form); 
        formData.append('request_id', requestID)

        const message = formData.get('message')?.trim() // get text input value
        const media = formData.get('media')


        // Send a POST request via fetch
        if(!(message === "") || (media.size > 0)){ // make sure text input is not empty or file is uploaded
            fetch('{{ url_for("chat.send_message") }}', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    console.log(data)
                    socket.emit('send_message', data)
                }
                    
                )
                .catch((error) => {
                    console.error('Error:', error)
                })
        }

        form.reset() // Clear form after request is sent

    })  

    
        



</script>


{% endblock %}