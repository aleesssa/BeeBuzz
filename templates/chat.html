{% extends 'base.html' %}

{% block content %}
<h1>Chatbox</h1>

<div class="chatbox">
    <ul class="messages" style="list-style: none;">
        {% for message in messages %}
        <!-- Get sender's name and message -->
        <li class="message">
            {% if message.media_url %} 
            <img src="{{ message.media_url }}" width="200px">
            {% endif %}
            <div class="text">{{ users.filter_by(id=message.sender_id).first().username}} : {{ message.message }}</div>
        </li> 
        {% endfor %}
    </ul>
    <form id="chat_form" enctype="multipart/form-data">
        <input type="text" name="message" id="chat_input" placeholder="Send a text">
        <input type="file" name="media" id="media" accept="image/*,video/*">
        <input type="button" id="submit">Send</button>
    </form>  
</div>



<script>
    const form = document.getElementById('chat_form')
    const input = document.getElementById('chat_input') // Needed to track Enter key presses
    const submitButton = document.getElementById('submit')


    // Click submit button when user presses enter
    input.addEventListener("keypress", (event) => {
        if (event.key === "Enter") {
            // Cancel the default action, if needed
            event.preventDefault();
            // Trigger sendButton with a click
            submitButton.click();
        }
    }); 


    // send post request through fetch when form is submitted 
    submitButton.addEventListener('click', (e) => {
        e.preventDefault();
        const formData = new FormData(form); 

        const message = formData.get('message')?.trim() // get text input value
        const media = formData.get('media')

        if(!(message === "") || (media.size > 0)){ // make sure text input is not empty or file is uploaded
            fetch('{{ url_for("chat.send_message") }}', {
                method: 'POST',
                body: formData
            })
                .then(response => response.json())
                .then(data => {
                    console.log('Success:', data.message)
                    location.reload()
                }
                    
                )
                .catch((error) => {
                    console.error('Error:', error)
                })
        }

        form.reset() // Clear form after request is sent

    })
        



</script>


{% endblock %}